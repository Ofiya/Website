name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'Redweb01'  # Change to your actual Azure app name
  AZURE_WEBAPP_PACKAGE_PATH: '.'      # Location of your code

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Create minimal package.json (if missing)
      run: |
        if [ ! -f "package.json" ]; then
          cat > package.json << 'EOF'
          {
            "name": "ccc-redemption-parish",
            "version": "1.0.0",
            "description": "Celestial Church of Christ Redemption Parish Winnipeg",
            "main": "index.html",
            "scripts": {
              "start": "echo 'Static website - no build required'"
            },
            "keywords": ["church", "celestial", "winnipeg", "website"],
            "author": "Celestial Church of Christ Redemption Parish",
            "license": "MIT"
          }
          EOF
        fi
    
    - name: Create simple Node.js server for Azure
      run: |
        cat > server.js << 'EOF'
        const http = require('http');
        const fs = require('fs');
        const path = require('path');
        
        const mimeTypes = {
          '.html': 'text/html',
          '.css': 'text/css',
          '.js': 'text/javascript',
          '.json': 'application/json',
          '.png': 'image/png',
          '.jpg': 'image/jpeg',
          '.gif': 'image/gif',
          '.svg': 'image/svg+xml',
          '.ico': 'image/x-icon'
        };
        
        const port = process.env.PORT || 3000;
        
        const server = http.createServer((req, res) => {
          // Remove query parameters
          let filePath = '.' + req.url.split('?')[0];
          
          // Default to index.html
          if (filePath === './' || filePath === '.') {
            filePath = './index.html';
          }
          
          // Handle SPA routing - redirect to index.html for HTML5 pushState
          const extname = path.extname(filePath);
          if (extname === '' && !filePath.includes('.')) {
            filePath = './index.html';
          }
          
          const contentType = mimeTypes[path.extname(filePath)] || 'application/octet-stream';
          
          fs.readFile(filePath, (error, content) => {
            if (error) {
              if (error.code === 'ENOENT') {
                // File not found, try 404.html
                fs.readFile('./404.html', (error404, content404) => {
                  if (error404) {
                    // 404.html not found, send basic 404
                    res.writeHead(404, { 'Content-Type': 'text/html' });
                    res.end('<h1>404 Not Found</h1>', 'utf-8');
                  } else {
                    res.writeHead(404, { 'Content-Type': 'text/html' });
                    res.end(content404, 'utf-8');
                  }
                });
              } else {
                // Server error
                res.writeHead(500);
                res.end('Sorry, server error: ' + error.code);
              }
            } else {
              // Success
              res.writeHead(200, { 'Content-Type': contentType });
              res.end(content, 'utf-8');
            }
          });
        });
        
        server.listen(port, () => {
          console.log(`Server running at http://localhost:${port}/`);
        });
        EOF
    
    - name: Zip deployment package
      run: |
        zip -r deployment.zip . -x "*.git*" "*.github*"
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: deployment.zip